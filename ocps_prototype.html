

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Rubin OCS Controlled Pipeline System (OCPS) prototype &mdash; UWS API Server  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="OCPS Job Manager API" href="api/Readme.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> UWS API Server
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Development.html">Development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="Development.html#documentation-system">Documentation system</a><ul>
<li class="toctree-l3"><a class="reference internal" href="Development.html#sphinx">Sphinx</a></li>
<li class="toctree-l3"><a class="reference internal" href="Development.html#github-actions-and-pages">GitHub Actions and Pages</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Development.html#file-editors-and-viewers">File editors and viewers</a></li>
<li class="toctree-l2"><a class="reference internal" href="Development.html#development-environment">Development environment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api/Readme.html">OCPS Job Manager API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Rubin OCS Controlled Pipeline System (OCPS) prototype</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prototype">Prototype</a></li>
<li class="toctree-l2"><a class="reference internal" href="#server-ocps-job-manager">Server - OCPS Job Manager</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#job-manager-api-specification">Job Manager API Specification</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#client-ocsp-csc">Client - OCSP CSC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#job-management">Job Management</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">UWS API Server</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Rubin OCS Controlled Pipeline System (OCPS) prototype</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/lsst-dm/uws-api-server/blob/master/docs/ocps_prototype.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rubin-ocs-controlled-pipeline-system-ocps-prototype">
<h1>Rubin OCS Controlled Pipeline System (OCPS) prototype<a class="headerlink" href="#rubin-ocs-controlled-pipeline-system-ocps-prototype" title="Permalink to this headline">¶</a></h1>
<div class="section" id="prototype">
<h2>Prototype<a class="headerlink" href="#prototype" title="Permalink to this headline">¶</a></h2>
<img alt="_images/Prompt_processing_architecture_sketch.png" src="_images/Prompt_processing_architecture_sketch.png" />
<p>The prototype OCPS Job Manager is designed as an evolving demonstration of the emerging system.</p>
<p>The prototype consists of a server and a client.</p>
<ul class="simple">
<li><p>The server is a <a class="reference external" href="https://www.tornadoweb.org/en/stable/">Tornado-based webserver</a> written in Python, which runs on the NCSA Test Stand (NTS) Kubernetes cluster.</p></li>
<li><p>The client represents the OCPS CSC that will ultimately be submitting jobs and fetching the results. The client is a Python script that could in principle be executed on any machine that can access the OCPS Job Manager HTTP port.</p></li>
</ul>
</div>
<div class="section" id="server-ocps-job-manager">
<h2>Server - OCPS Job Manager<a class="headerlink" href="#server-ocps-job-manager" title="Permalink to this headline">¶</a></h2>
<p>The OCPS Job Manager is the <code class="docutils literal notranslate"><span class="pre">server/server.py</span></code> module, which implements a Universal Worker Service (UWS) API server to provide an asynchronous job management system that follows the <a class="reference external" href="https://www.ivoa.net/documents/UWS/">Universal Worker Service Pattern defined by the International Virtual Observatory Alliance</a>.</p>
<div class="section" id="job-manager-api-specification">
<h3>Job Manager API Specification<a class="headerlink" href="#job-manager-api-specification" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For the definition of the API spec, see <a class="reference internal" href="api/Readme.html"><span class="doc">OCPS Job Manager API</span></a>. <strong>This may not reflect the current prototype.</strong></p>
</div>
</div>
</div>
<div class="section" id="client-ocsp-csc">
<h2>Client - OCSP CSC<a class="headerlink" href="#client-ocsp-csc" title="Permalink to this headline">¶</a></h2>
<p>As currently envisioned, the data (e.g. camera images) that form the input to the prompt processing jobs will be transferred from the OCS by an independent system; thus the input data is assumed to be accessible to the UWS as a Butler repo residing on some locally mounted storage.</p>
<p>The prototype client (the <code class="docutils literal notranslate"><span class="pre">client/client.py</span></code> module) provides some wrapper functions around the API server endpoints, as well as a demo of some HTTP requests that create and manage jobs.</p>
<p>See the <a class="reference internal" href="client_demo.html"><span class="doc">UWS Client Demo</span></a> for details.</p>
</div>
<div class="section" id="job-management">
<h2>Job Management<a class="headerlink" href="#job-management" title="Permalink to this headline">¶</a></h2>
<p>Jobs run as Kubernetes Jobs. The container image for each job is the <code class="docutils literal notranslate"><span class="pre">lsstsqre/centos:d_latest</span></code> Docker image.</p>
<p>Create a job:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PUT</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">job</span>

<span class="n">Parameters</span><span class="p">:</span>

  <span class="n">command</span> <span class="o">-</span> <span class="n">command</span> <span class="n">to</span> <span class="n">execute</span>
  <span class="n">run_id</span> <span class="o">-</span> <span class="n">custom</span> <span class="n">identifier</span> <span class="k">for</span> <span class="n">client</span> <span class="n">use</span> <span class="n">only</span>
  <span class="n">environment</span> <span class="o">-</span> <span class="n">array</span> <span class="n">of</span> <span class="n">objects</span> <span class="k">with</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">value</span> <span class="n">specifying</span> <span class="n">the</span> <span class="n">environment</span> <span class="n">variables</span> <span class="k">for</span> <span class="n">the</span> <span class="n">executing</span> <span class="n">script</span>
  <span class="n">url</span> <span class="o">-</span> <span class="n">git</span> <span class="n">repo</span> <span class="n">URL</span> <span class="n">to</span> <span class="n">clone</span> <span class="k">for</span> <span class="n">use</span> <span class="n">by</span> <span class="n">job</span> <span class="n">script</span>
  <span class="n">commit_ref</span> <span class="o">-</span> <span class="n">git</span> <span class="n">reference</span> <span class="p">(</span><span class="n">branch</span> <span class="n">name</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="n">denoting</span> <span class="n">the</span> <span class="n">desired</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">state</span>
</pre></div>
</div>
<p>Get info about a specific job with ID <code class="docutils literal notranslate"><span class="pre">{jobId}</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">job</span><span class="o">/</span><span class="p">{</span><span class="n">jobId</span><span class="p">}</span>

<span class="n">Response</span><span class="p">:</span>

<span class="p">{</span>
    <span class="s2">&quot;jobId&quot;</span><span class="p">:</span> <span class="s2">&quot;e13ed9f2803842409763b185d4f490e2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;runId&quot;</span><span class="p">:</span> <span class="s2">&quot;my-special-job&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ownerId&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;executing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;creationTime&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-03-17 20:58:54+00:00&quot;</span><span class="p">,</span>
    <span class="s2">&quot;startTime&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-03-17 20:58:54+00:00&quot;</span><span class="p">,</span>
    <span class="s2">&quot;endTime&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;executionDuration&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;destruction&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cd /uws/jobs/e13ed9f2803842409763b185d4f490e2/src &amp;&amp; ls -l &gt; $JOB_OUTPUT_DIR/dirlist.txt&quot;</span>
      <span class="p">],</span>
      <span class="s2">&quot;environment&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;DATA_DIR_COMCAM&quot;</span><span class="p">,</span>
          <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;/data/lsstdata/comcam/oods/butler/repo&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;DATA_DIR_AUXTEL&quot;</span><span class="p">,</span>
          <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;/data/lsstdata/auxTel/oods/butler/repo&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;JOB_SOURCE_DIR&quot;</span><span class="p">,</span>
          <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;/uws/jobs/e13ed9f2803842409763b185d4f490e2/src&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;SRC_GIT_URL&quot;</span><span class="p">,</span>
          <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/lsst-dm/uws-api-server&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;GIT_COMMIT_REF&quot;</span><span class="p">,</span>
          <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;JOB_OUTPUT_DIR&quot;</span><span class="p">,</span>
          <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;/uws/jobs/e13ed9f2803842409763b185d4f490e2/out&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;errorSummary&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;jobInfo&quot;</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>List jobs that are executing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GET /api/v1/job?phase=executing

Response:

[
  {
    &quot;jobId&quot;: &quot;e13ed9f2803842409763b185d4f490e2&quot;,
    &quot;runId&quot;: &quot;my-special-job&quot;,
    &quot;ownerId&quot;: &quot;&quot;,
    &quot;phase&quot;: &quot;executing&quot;,
    &quot;creationTime&quot;: &quot;2021-03-17 20:58:54+00:00&quot;,
    &quot;startTime&quot;: &quot;2021-03-17 20:58:54+00:00&quot;,
    ...
    additional details omitted for brevity
    ...
  },
  {
    &quot;jobId&quot;: &quot;a6b9043ef0c24170b019641da57a0dba&quot;,
    &quot;runId&quot;: &quot;my-other-job&quot;,
    &quot;ownerId&quot;: &quot;&quot;,
    &quot;phase&quot;: &quot;executing&quot;,
    &quot;creationTime&quot;: &quot;2021-03-17 15:58:54+00:00&quot;,
    &quot;startTime&quot;: &quot;2021-03-17 16:58:54+00:00&quot;,
    ...
    additional details omitted for brevity
    ...
  }
]
</pre></div>
</div>
<p>Get the phase of job with ID <code class="docutils literal notranslate"><span class="pre">{jobId}</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">job</span><span class="o">/</span><span class="p">{</span><span class="n">jobId</span><span class="p">}</span><span class="o">/</span><span class="n">phase</span>

<span class="n">Response</span><span class="p">:</span>

<span class="s2">&quot;completed&quot;</span>
</pre></div>
</div>
<p>Job results are defined as the files generated during execution in the job output folder, whose path is available to the job script via an environment variable <code class="docutils literal notranslate"><span class="pre">$JOB_OUTPUT_DIR</span></code>. The UWS job object spec recommends an ID and a URI. Our URI is the path to the result file and the ID is the base64-encoded version of that path string, which is amenable to URLs and has the benefit of encoding the files universally unique path on disk (since the job UUID is part of the file path).</p>
<p>Get the results of job with ID <code class="docutils literal notranslate"><span class="pre">{jobId}</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">job</span><span class="o">/</span><span class="p">{</span><span class="n">jobId</span><span class="p">}</span><span class="o">/</span><span class="n">results</span>

<span class="n">Response</span><span class="p">:</span>

<span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;L3V3cy9qb2JzL2UxM2VkOWYyODAzODQyNDA5NzYzYjE4NWQ0ZjQ5MGUyL291dC9kaXJsaXN0LnR4dA==&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uri&quot;</span><span class="p">:</span> <span class="s2">&quot;/uws/jobs/</span><span class="si">{jobId}</span><span class="s2">/out/dirlist.txt&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Download a job result file from job with result ID <code class="docutils literal notranslate"><span class="pre">{resultId}</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">job</span><span class="o">/</span><span class="n">result</span><span class="o">/</span><span class="p">{</span><span class="n">resultId</span><span class="p">}</span>

<span class="n">Response</span><span class="p">:</span>

<span class="p">(</span><span class="n">requested</span> <span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="api/Readme.html" class="btn btn-neutral float-left" title="OCPS Job Manager API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, T. Andrew Manning.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>